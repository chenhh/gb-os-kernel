# BIOS

## BIOS的目標

BIOS的最主要的功能：初始化硬體平台和提供硬體的軟體抽象層，引導作業系統啟動。

* 輸入的是：硬體平台的資訊
* 輸出的是：硬體的軟體抽象層


然後將引導檔案加載至記憶體引導作業系統啟動。

## 簡介

在UEFI被發明之前，PC桌機都在用傳承自1979年的傳統BIOS。初代BIOS由幾個IBM工程師開發，他們從沒有想到自己寫的組合語言程式會用這麼久。傳統BIOS在發明後雖經過修修補補，但本質沒有絲毫變化：一堆用組語寫的硬體初始化程式碼，可正常工作，但它封閉、神秘和充滿各種不清不楚的預設和祖傳程式碼。

考慮到底層編程的復雜性以及希望作業系統盡可能少地去瞭解平台的硬體細節，在平台韌體和OS加載器間使用高級C語言介面看起來成為一個必然選擇。有了這個絕佳的想法，為啟動過程定義一個在韌體和作業系統間CPU架構無關的API 只是剩下最後的一躍而已。在Intel的努力下，新的方案被廣泛討論，並在1999推出1.0 spec,並被定名EFI。後成立Forum，改名UEFI。

當電腦開機時，CPU從主機板的BIOS晶片內取得程式，由BIOS內部的程式獲得硬體控制權並作用，從CPU內外部檢測設置，啟動DRAM，以及針對晶片組與外部設備作初始化設置後，最後驅動硬碟直到作業系統加載成功，BIOS的工作交棒給作業系統的bootloader後工作完成。

BIOS平時儲存於ROM中(EPROM或FLASH)，除了特殊工具和方法之外，任何應用程式無法對BIOS進行修改或刪除。

對於新的CPU硬體，BIOS為了相容性，通常會使用CPUID的功能調整部份功能，其餘大部份程式碼不需修改即可使用。

BIOS產業是科技和人力密集型企業。BIOS對熟練工程師需求相當大，因為BIOS對硬體的改變相當敏感，硬體小變需要小改，大變需要大改。

BIOS韌體


BOOT是載入執行的一個預啟動的操作環境程式，嚴格來算是軟體，通常用組合語言編寫。是一組固化到計算機內主機板上一個ROM晶片上的程式。它儲存著計算機最重要的基本輸入輸出的程式、系統設定資訊、開機後自檢程式和系統自啟動程式。其主要功能是為計算機提供最底層的、最直接的硬體設定和控制。

<figure><img src="../.gitbook/assets/bios\_setting.png" alt="" width="500">
<figcaption>Award BIOS設定畫面</figcaption>
</figure>

一般稱BIOS是指主機板的BIOS，而其它的週邊也有自已的BIOS ROM，像是顯示卡、高階網路卡等，因為較複雜的外接週邊硬體設計差異很大，各自有其獨特初始動作，所以廠商會另外加上BIOS ROM。


然而，不適當的執行或是終止 BIOS 更新可能導致電腦或是裝置的不堪使用。為了避免 BIOS 損壞，有些新的主機板有備份的 BIOS ("雙BIOS"主機板)，主要是因為CIH病毒可破壞BIOS。

當PC開機，BIOS 是由電路板上的ROM執行，並且他將晶片組和記憶體子系統順序起始化。他把自己從ROM中解壓縮到系統的主記憶體，並且從那邊開始執行。PC 的 BIOS 程式碼也包含診斷功能，以保證某些重要硬體元件的正確，像是鍵盤，磁碟裝置，輸出輸入埠等等，這些可以正常運作且正常地初始化。幾乎所有的 BIOS 都可以選擇性地執行 CMOS 記憶體的設定程式; 也就是儲存 BIOS 會存取的使用者自訂設定資料(時間、日期、硬碟細節，等等)。

現在的新式電腦用的基本都是UEFI啟動，早期的過渡電腦用的都是EFI啟動。其實EFI或UEFI的一部分也是儲存在一個晶片中，由於它們在表面形式、基本功能上和BIOS差不多，所以習慣上我們也把儲存EFI/UEFI的晶片叫做EFI/UEFI BIOS晶片，EFI/UEFI也叫做EFI/UEFI BIOS，但在實際上它們和BIOS根本是不一樣的設計。

## BIOS主要功能

BIOS用於**硬體自檢 (power on self test, POST)**、**CMOS設定**、**引導作業系統啟動**、**提供硬體I/O**、硬體中斷等4項主要功能，

因此BIOS程式可以分為若干模組，主要有Boot Block引導模組、CMOS設定模組、擴充套件配置資料（ESCD）模組、DMI收集硬體資料模組。

其中引導模組直接負責執行BIOS程式本身入口、電腦基本硬體的檢測和初始化，ESCD用於BIOS與OS交換硬體配置資料，DMI則充當了硬體管理工具和系統層之間介面的角色，通過DMI，使用者可以直觀地獲得硬體的任何資訊，CMOS設定模組就是實現對硬體資訊進行設定，並儲存在CMOS中，是除了啟動初始化以外BIOS程式最常用的功能。

## BIOS設置

BIOS的設定值，是儲存在主機板上的CMOS晶片，此晶片以主機板上的鋰電池供電。現代主機板將CMOS整合到南橋晶片或Super IO晶片

x86真實模式下的記憶體佈局


BIOS本身是組合語言程式碼，是在16位元真實模式下呼叫INT 13H中斷執行的。由於x86-64是一個高度相容的指令集，也為了遷就BIOS的16位元真實模式的執行環境，所以即使現在的CPU都已是64位元，還是在BIOS啟動（常見於09年以前的主機板），在開機時仍然都是在16位真實模式下執行的。16位真實模式直接能訪問的記憶體只有1MB。

在這1MB記憶體中，頂層640K稱為基本記憶體，後面384K記憶體留給開機必要硬體和各類BIOS本身使用。

相容x86的CPU(如AMD，cyrix)在BIOS設置或設置上有相似的配置。

| 起始    | 結束    | 大小        | 用途                                                                                      |
| ----- | ----- | --------- | --------------------------------------------------------------------------------------- |
| FFFF0 | FFFFF | 16 Bytes  | BIOS入口地址，此地址也屬於BIOS程式碼，同樣屬於頂部的64 KB位元組。只是為了強調入口地址才單獨寫出。此處16位元組的內容是跳轉指令 `JMP F000:E05B`。 |
| F0000 | FFFEF | 64KB\~16B | 系統BIOS的範圍是F0000\~FFFFF共640 KB，為了說明入口地址，將最上面的16 Bytes從此處扣除，所以結束地址是FFFEF。                 |
| C8000 | EFFFF | 160KB     | 映射硬體配接器的ROM或是記憶體映射的I/O                                                                  |
| C0000 | C7FFF | 32KB      | 顯示配接器BIOS                                                                               |
| B8000 | BFFFF | 32KB      | 文字模式顯示的配接器                                                                              |
| B0000 | B7FFF | 32KB      | 用於黑白顯示配接器(通常保留未用)                                                                       |
| A0000 | AFFFF | 64KB      | 用於彩色顯示配接器(VGA)                                                                          |
| 9FC00 | 9FFFF | 1KB       | EBDA (extended BIOS data area)                                                          |
| 7E00  | 9EBFF | 約608KB    | 可用區域                                                                                    |
| 7C00  | 7DFF  | 512B      | MBR被BIOS加載到此處，共512B                                                                     |
| 500   | 7BFF  | 約30KB     | 可用區域                                                                                    |
| 400   | 4FF   | 256B      | BIOS data area                                                                          |
| 000   | 3FF   | 1KB       | Interrupt Vector Table(中斷向量表)                                                           |

## BIOS啟動流程

1. 系統開機後，第一步通電自檢（Power On Self Test, POST）。在傳統BIOS的上電階段，通過IO列舉發現匯流排，進入到標准描述的平台介面部分。
2. POST過後初始化用於啟動的硬體（磁碟、鍵盤控制器等）。
3. BIOS會執行BIOS磁碟啟動順序中第一個磁碟的首440bytes（MBR啟動程式碼區域）內的程式碼。
4. 啟動引導程式碼從BIOS獲得控制權，然後引導啟動下一階段的程式碼（如果有的話）（一般是系統的啟動引導程式碼）。
5. 再次被啟動的程式碼（二階段程式碼）（即啟動引導）會查閱支援和配置檔案。
6. 根據配置檔案中的資訊，啟動載入程式會將核心和initramfs檔案載入系統的RAM中，然後開始啟動核心。

<figure><img src="../.gitbook/assets/post\_test.png" alt="" width="500">
<figcaption>通電自檢(POST)</figcaption>
</figure>

硬體初始化工作中，主要說明兩點，首先經過POST檢測後，電腦終於出現了開機啟動畫面，這就是已經檢測到了顯示卡並完成了初始化。但是請注意，由於BIOS是在16位真實模式執行，因此該畫面是以VGA解析度（640\*480，縱橫比4:3）顯示的，因為真實模式最高支援的就是VGA。

BIOS只識別到由主開機記錄（MBR）初始化的硬碟，之所以說明這點，是因為後續的EFI或UEFI採用了一種新的GUID磁碟分割槽系統（GPT）格式，這種硬碟在BIOS下是無法識別的。硬體全部初始化完畢後，接下來進入更新ESCD階段。

在ESCD更新階段中，BIOS將對儲存在CMOS中和作業系統交換的硬體配置資料進行檢測，如果系統硬體發生變動，則會更新該資料，否則不更新保持原狀不變，ESCD檢測或更新結束後，BIOS將完成最後一項工作，就是啟動作業系統。

最後這一步中，BIOS根據CMOS中使用者指定的硬體啟動順序，讀取相應裝置的啟動或引導記錄，引導相應裝置上的作業系統啟動，進入作業系統，此後便由作業系統接替BIOS負責硬體和軟體間的相互通訊。如果發現所有硬體都沒有能引導作業系統的記錄，則會在螢幕上顯示相應錯誤資訊，並將電腦維持在16位真實模式。

## BIOS 中斷向量表 (interrupt vector table)

| 中斷編碼    | 描述                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| ------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| INT 00h | CPU：除以零錯，或商不合法時觸發&#xD;。                                                                                                                                                                                                                                                                                                                                                                                                                  |
| INT 01h | CPU：單步陷阱，TF標記為打開狀態時，每條指令執行後觸發&#xD;。                                                                                                                                                                                                                                                                                                                                                                                                      |
| INT 02h | CPU：非可封鎖中斷，如啟動自我測試時發生記憶體錯誤。                                                                                                                                                                                                                                                                                                                                                                                                              |
| INT 03h | CPU：第一個未定義的中斷向量，約定俗成僅用於除錯程式&#xD;。                                                                                                                                                                                                                                                                                                                                                                                                        |
| INT 04h | CPU：算數溢位。通常由INTO指令在置溢位位時觸發。&#xD;                                                                                                                                                                                                                                                                                                                                                                                                         |
| INT 05h | 在按下Shift-Print Screen或BOUND指令檢測到範圍異常時觸發。&#xD;                                                                                                                                                                                                                                                                                                                                                                                            |
| INT 06h | CPU：非法指令。&#xD;                                                                                                                                                                                                                                                                                                                                                                                                                           |
| INT 07h | CPU：沒有數學協處理器時嘗試執行浮點指令觸發。&#xD;                                                                                                                                                                                                                                                                                                                                                                                                            |
| INT 08h | IRQ0：可程式化中斷控制器每 55 毫秒觸發一次，即每秒 18.2 次。&#xD;                                                                                                                                                                                                                                                                                                                                                                                               |
| INT 09h | IRQ1：每次鍵盤按下、按住、釋放。&#xD;                                                                                                                                                                                                                                                                                                                                                                                                                  |
| INT 0Ah | IRQ2：&#xD;                                                                                                                                                                                                                                                                                                                                                                                                                               |
| INT 0Bh | IRQ3：COM2/COM4。&#xD;                                                                                                                                                                                                                                                                                                                                                                                                                     |
| INT 0Ch | IRQ4：COM1/COM3。&#xD;                                                                                                                                                                                                                                                                                                                                                                                                                     |
| INT 0Dh | IRQ5：硬碟控制器（PC/XT 下）或 LPT2。                                                                                                                                                                                                                                                                                                                                                                                                               |
| INT 0Eh | IRQ6：需要時由軟碟控制器呼叫。&#xD;                                                                                                                                                                                                                                                                                                                                                                                                                   |
| INT 0Fh | IRQ7：LPT1。&#xD;                                                                                                                                                                                                                                                                                                                                                                                                                          |
| INT 10h | <p>顯示服務 - 由BIOS或作業系統設定以供軟體呼叫。
</p><ul><li>AH=00h
：設定顯示模式</li><li>AH=01h
：設定游標形態
</li><li>AH=02h
：設定游標位置
</li><li>AH=03h
：取得游標位置與形態
</li><li>AH=04h
：取得游標位置
</li><li>AH=05h
：設定顯示頁
</li><li>AH=06h
：清除或捲軸畫面(上)
</li><li>AH=07h
：清除或捲軸畫面(下)
</li><li>AH=08h
：讀取游標處字元與屬性
</li><li>AH=09h
：更改游標處字元與屬性
</li><li>AH=0Ah
：更改游標處字元
</li><li>AH=0Bh
：設定邊界顏色
</li><li>AH=0Eh
：在TTY模式下寫字元
</li><li>AH=0Fh
：取得目前顯示模式
</li><li>AH=13h
：寫字串
</li></ul> |
| INT 11h | 返回裝置列表。                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| INT 12h | 取得常規記憶體容量。&#xD;                                                                                                                                                                                                                                                                                                                                                                                                                          |
| INT 13h | <p>低階磁碟服務。
</p><ul><li>AH=00h：復位磁碟機。
</li><li>AH=01h：檢查磁碟機狀態。
</li><li>AH=02h：讀磁區。
</li><li>AH=03h：寫磁區。
</li><li>AH=04h：校驗磁區。
</li><li>AH=05h：格式化磁軌。
</li><li>AH=08h：取得驅動器引數。
</li><li>AH=09h：初始化硬碟機引數。
</li><li>AH=0Ch：尋道。
</li><li>AH=0Dh：復位硬碟控制器。
</li><li>AH=15h：取得驅動器型別。
</li><li>AH=16h：取得軟碟機中碟片的狀態。
</li></ul>                                                                                                                    |
| INT 14h | <p>序列埠通訊常式。
</p><ul><li>AH=00h：初始化序列埠。
</li><li>AH=01h：寫出字元。
</li><li>AH=02h：讀入字元。
</li><li>AH=03h：狀態。
</li></ul>                                                                                                                                                                                                                                                                                                                        |
| INT 15h | <p>其它（系統支援常式）。
</p><ul><li>AH=4Fh：鍵盤攔截。
</li><li>AH=83h：事件等待。
</li><li>AH=84h：讀遊戲桿。
</li><li>AH=85h：SysRq 鍵。
</li><li>AH=86h：等待。
</li><li>AH=87h：塊移動。
</li><li>AH=88h：取得擴充記憶體容量。
</li><li>AH=C0h：取得系統引數。
</li><li>AH=C1h：取得擴充 BIOS 資料區段。
</li><li>AH=C2h：指標裝置功能。
</li><li>AH=E8h, AL=01h (AX = E801h)：取得擴充記憶體容量（自從 1994 年引入的新功能），可取得到 64MB 以上的記憶體容量。
</li><li>AH=E8h, AL=20h (AX = E820h)	查詢系統位址對映。該功能取代了 AX=E801h 和 AH=88h。
</li></ul>  |
| INT 16h | <p>鍵盤通訊常式。
</p><ul><li>AH=00h：讀字元。
</li><li>AH=01h：讀輸入狀態。
</li><li>AH=02h：讀 Shift 鍵（修改鍵）狀態。
</li><li>AH=10h：讀字元（增強版）。
</li><li>AH=11h：讀輸入狀態（增強版）。
</li><li>AH=12h：讀 Shift 鍵（修改鍵）狀態（增強版）。
</li></ul>                                                                                                                                                                                                                                      |
| INT 17h | <p>列印服務。
</p><ul><li>AH=00h：列印字元。
</li><li>AH=01h：初始化印表機。
</li><li>AH=02h：檢查印表機狀態。
</li></ul>                                                                                                                                                                                                                                                                                                                                            |
| INT 18h | 執行磁帶上的 BASIC 程式：「真正的」IBM 相容機在 ROM 裡內建 BASIC 程式，當啟動失敗時由 BIOS 呼叫此常式解釋執行。（例：列印「Boot disk error. Replace disk and press any key to continue...」這類提示資訊）&#xD;                                                                                                                                                                                                                                                                                  |
| INT 19h | 加電自檢之後載入作業系統。                                                                                                                                                                                                                                                                                                                                                                                                                            |
| INT 1Ah | <p>時鍾服務。
</p><ul><li>AH=00h：讀取即時鍾。
</li><li>AH=01h：設定即時鍾。
</li><li>AH=02h：讀取即時鍾時間。
</li><li>AH=03h：設定即時鍾時間。
</li><li>AH=04h：讀取即時鍾日期。
</li><li>AH=05h：設定即時鍾日期。
</li><li>AH=06h：設定即時鍾鬧鈴。
</li><li>AH=07h：重設即時鍾鬧鈴。</li></ul>                                                                                                                                                                                                                |
| INT 1Bh | Ctrl+Break，由 IRQ 9 自動呼叫。&#xD;                                                                                                                                                                                                                                                                                                                                                                                                            |
| INT 1Ch | 預留，由 IRQ 8 自動呼叫。                                                                                                                                                                                                                                                                                                                                                                                                                         |
| INT 1Dh | 不可呼叫：指向影片引數列（包含影片模式的資料）的指標。&#xD;                                                                                                                                                                                                                                                                                                                                                                                                         |
| INT 1Eh | 不可呼叫：指向軟碟模式表（包含關於軟碟機的大量資訊）的指標。&#xD;                                                                                                                                                                                                                                                                                                                                                                                                      |
| INT 1Fh | 不可呼叫：指向影片圖形字元表（包含從 80h 到 FFh 的 ASCII 字元的資料）的資訊。&#xD;                                                                                                                                                                                                                                                                                                                                                                                     |
| INT 41h | 位址指標：硬碟引數列（第一硬碟）。&#xD;                                                                                                                                                                                                                                                                                                                                                                                                                   |
| INT 46h | 位址指標：硬碟引數列（第二硬碟）。&#xD;                                                                                                                                                                                                                                                                                                                                                                                                                   |
| INT 4Ah | 即時鍾在鬧鈴時呼叫。&#xD;                                                                                                                                                                                                                                                                                                                                                                                                                          |
| INT 70h | IRQ8：由即時鐘呼叫。&#xD;                                                                                                                                                                                                                                                                                                                                                                                                                        |
| INT 74h | IRQ12：由滑鼠呼叫&#xD;                                                                                                                                                                                                                                                                                                                                                                                                                         |
| INT 75h | IRQ13：由數學協處理器呼叫。&#xD;                                                                                                                                                                                                                                                                                                                                                                                                                    |
| INT 76h | IRQ14：由第一個 IDE 控制器所呼叫&#xD;。                                                                                                                                                                                                                                                                                                                                                                                                              |
| INT 77h | IRQ15：由第二個 IDE 控制器所呼叫&#xD;。                                                                                                                                                                                                                                                                                                                                                                                                              |

## 為什麼電腦開機第一幕顯示的是顯示卡資訊?

這個畫面是是顯卡的韌體：opROM顯示的。是在BIOS調度它的時候（dispatch）。opROM在自我展示後，才會掛載傳統的INT10等。有些外接卡也會不失時機的自我表演。

因為它是顯卡的opROM啊，別人根本沒有機會搶在前面。等INT10掛號之後，它們才有機會上場。

這種情形在legacy BIOS很常見，而在UEFI後變少，因為純UEFID的opROM掛載GOP，顯卡不方便出來表演，但不少GOP是在傳統opROM上加了thunk，並非純UEFI。

## 為何只有x86系統有BIOS？主流ARM體系就不用BIOS呢？

在某種意義上來說，x86體系比ARM體系更加開放。x86是很多廠商(作業系統廠商、CPU廠商、主機板廠商、獨立硬體廠商)一起玩，以生態圈的概念提供產品，並對自己那部分負責；而ARM體系雖然也依賴生態圈，但最終有個大廠商(品牌廠如三星、SONY、華為等)統合整個生態鏈，提供最後產品並對該產品負總責。

在x86生態圈十分強勢的微軟責作業系統開發，跳過品牌直接服務最終用戶，因此它要直接面對數千數萬種千奇百怪的硬體產品，**如何才能用一個軟體安裝包服務於這麼多種設備呢？必須要一個軟件抽象層封裝這些硬體差別**。

這就引出了BIOS的最主要的功能：**初始化硬體和提供硬體的軟體抽象層**。

* ARM體系也要初始化具體主機板相關硬體如GPIO和記憶體等，這些一般在BSP中完成。與x86體系不同之處在於這些硬體完全客製化，初始化的時候就預先知道有哪些設備，到時候就初始化一大堆規劃好的暫存器而已。x86系統配置情況在開機時候是不知道的，需要探測（Probe）、Training(記憶體和PCIe)和枚舉（PCIe等等即插即用設備），相對較復雜。
* BIOS提供了整個主機板、包括主機板上外插的設備的軟體抽象。通過探測、Training和枚舉，BIOS就有了系統所有硬體的資訊。它通過幾組詳細定義好的介面，把這些資訊抽象後傳遞給作業系統，這些資訊包括**SMBIOS、ACPI表（ACPI與UEFI），記憶體對映表（E820或者UEFI運行時）**等等。通過這層對映，才能做到做到作業系統完全不改而能夠適配到所有機型和硬體。

在某種程度上來講，BIOS是將作業系統BSP部分單獨封裝後下放到主機板或者BIOS提供商來完成。這在過去帶來了巨大的好處，舊的作業系統如WinXP、Win7現在還可以運行在更新的電腦硬體上，新的硬體只要自己更改一下就行了，相容性是ARM體系所不能比擬的。

當然割裂的生態圈也帶來了用戶感受的千差萬別，這也受到廣泛詬病。各自為政也窒息了創新，帶來了同質化。

ARM社群最近為了進入x86的傳統優勢領域，也開始接受UEFI，不過一般只在伺服器領域。個別廠商為了支援Windows而在平板等設備支援UEFI，不過這些只是支流，並且他們並不吧自己叫做BIOS，而叫做Bootloader。

在進入作業系統後，BIOS大部分內容都釋放了，但還留下了不少功能。

* SMM驅動。SMM驅動默默的等待在後台，在合適的情況會觸發（trap）運行。有不少主機板新奇的功能都靠它。
* ACPI表和代碼（Method）。DSDT和SSDT都有不少程式碼，這些都會被作業系統頻繁調度。
* UEFI 運行時。根據UEFI規範，BIOS提供了作業系統運行時需要的一些支援函數，例如讀寫存貯在BIOS Flash上的variable操作，reset等等。
* 其他。EC或者BMC等等都在監控系統，它們都有可能觸發事件，喊來BIOS幫忙。還有些特殊硬體，如顯卡還需要和opRegion進行互動。

