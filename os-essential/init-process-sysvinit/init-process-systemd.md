# init行程：systemd

## Upstart 簡介

大約在 2006 年或者更早的時候， Ubuntu 開發人員試圖將 Linux 安裝在筆記本電腦上。在這期間技術人員發現經典的 sysvinit 存在一些問題：它不適合筆電環境。這促使設計師 Scott James Remnant 著手開發 upstart。

當 Linux 內核進入 2.6 時代時，新特性使得 Linux 不僅是一款優秀的服務器操作系統，也可以被用於桌面系統，甚至嵌入式設備。桌面系統或便攜式設備的一個特點是經常重啟，而且要頻繁地使用硬件熱插拔技術。 在現代計算機系統中，硬件繁多、接口有限，人們並非將所有設備都始終連接在計算機上，比如 usb 隨身碟平時並不連接電腦，使用時才插入 USB 插口。因此，當系統上電啟動時，一些外設可能並沒有連接。而是在啟動後當需要的時候才連接這些設備。在 2.6 內核支持下，一旦新外設連接到系統，內核便可以自動實時地發現它們，並初始化這些設備，進而使用它們。這為便攜式設備用戶提供了很大的靈活性。

可是這些特性為 sysvinit 帶來了一些挑戰。當系統初始化時，需要被初始化的設備並沒有連接到系統上；比如印表機。為了管理印表機任務，系統需要啟動 CUPS 等服務，而如果印表機沒有接入系統的情況下，啟動這些服務就是一種浪費。**Sysvinit 沒有辦法處理這類需求，它必須一次性把所有可能用到的服務都啟動起來**，即使印表機並沒有連接到系統，CUPS 服務也必須啟動。

還有網路共享硬碟的掛載問題。在`/etc/fstab` 中，可以指定系統自動掛載一個網絡硬碟，比如 NFS，或者 iSCSI 設備。在sysvinit 分析`/etc/fstab` 掛載文件系統這個步驟是在網路啟動之前。可是如果網路沒有啟動，NFS 或者 iSCSI 都不可訪問，當然也無法進行掛載操作。Sysvinit 採用 netdev 的方式來解決這個問題，即`/etc/fstab` 發現 netdev 屬性掛載點的時候，不嘗試掛載它，在網路初始化並使能之後，還有一個專門的 netfs 服務來掛載所有這些網路硬碟。這是一個不得已的補救方法，給管理員帶來不便。部分新手管理員甚至從來也沒有聽說過 netdev 選項，因此經常成為系統管理的一個陷阱。

針對以上種種情況，Ubuntu 開發人員決定重新設計和開發一個全新的 init 系統，即 upstart。Upstart 基於事件機制，比如usb隨身碟插入 USB 接口後，udev 得到內核通知，發現該設備，這就是一個新的事件。Upstart 在感知到該事件之後觸發相應的等待任務，比如處理`/etc/fstab` 中存在的掛載點。採用這種事件驅動的模式，upstart 完美地解決了即插即用設備帶來的新問題。

此外，採用事件驅動機制也帶來了一些其它有益的變化，比如加快了系統啟動時間。sysvinit 運行時是同步阻塞的。一個腳本運行的時候，後續腳本必須等待。這意味著所有的初始化步驟都是串行執行的，而實際上很多服務彼此並不相關，完全可以並行啟動，從而減小系統的啟動時間。在 Linux 大量應用於服務器的時代，系統啟動時間也許還不那麼重要；然而對於桌面系統和便攜式設備，啟動時間的長短對用戶體驗影響很大。此外雲端計算等新的伺服端技術也往往需要單個設備可以更加快速地啟動。

